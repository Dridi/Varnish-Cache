varnishtest "vcldoc comments"

shell {
cat >test.vcl <<EOF
vcl 4.1;

## test.vcl
## ========
##
## This is a test VCL with no backend.
##
backend be none;

## vcl_recv
## --------
##
## Here we turn varnishd into a dumb proxy.
sub vcl_recv {
	return (pipe);
}
EOF

cat >test_stripped.vcl <<EOF
vcl 4.1;

backend be none;

sub vcl_recv {
	return (pipe);
}
EOF

cat >test_docs.txt <<EOF
test.vcl
========

This is a test VCL with no backend.

vcl_recv
--------

Here we turn varnishd into a dumb proxy.

EOF
}

varnish v1 -cliok "vcl.load test ${tmpdir}/test.vcl"
varnish v1 -start

shell {
	set -e
	varnishadm -n ${v1_name} vcl.show -d test >show.vcl
	varnishadm -n ${v1_name} vcl.show test >show_stripped.vcl
	varnishd -D -f ${tmpdir}/test.vcl >dump_docs.txt

	# NB: the cli prints an extra newline
	printf '\n' >>test.vcl
	printf '\n' >>test_stripped.vcl

	diff -u test.vcl show.vcl
	diff -u test_stripped.vcl show_stripped.vcl
	diff -u test_docs.txt dump_docs.txt
}
